on:
  workflow_dispatch:
  push:

jobs:
    test:
      runs-on: ubuntu-latest
      container:
        image: ghcr.io/anthmmatic/container1:main
        volumes:
          - gh-upstream:/opt/upstream:ro
      services:
        upstream:
          image: ghcr.io/anthmmatic/container1:service
          volumes:
            - gh-upstream:/opt/upstream:rw
          options: >
            --health-cmd "test -f /opt/upstream/.ready || [ -n \"$(ls -A /opt/upstream 2>/dev/null)\" ]"
            --health-interval 5s
            --health-timeout 3s
            --health-retries 20
      steps:
        - name: Wait for data to appear
          run: |
            for i in $(seq 1 60); do
              if [ -n "$(ls -A /opt/upstream 2>/dev/null)" ]; then
                echo "Data present in /opt/upstream"
                break
              fi
              echo "Waiting for upstream data..."
              sleep 2
            done
            ls -al /opt/upstream
        - name: Use the shared data
          run: ls -a /opt/upstream
